#!/bin/bash
# bk-analyze-skill-usage
#
# Generate a comprehensive skill usage analysis report from activity logs
# Analyzes skill invocations, performance metrics, and usage patterns
# Usage: bk-analyze-skill-usage [log-directory]
#
# Directory Resolution Order:
#   1. Command-line argument (if provided)
#   2. Global ~/.claude/activity-logs (default - hooks write here)
#   3. Current working directory's .claude/activity-logs (legacy fallback)
#   4. $BK_HOME/.claude/activity-logs (legacy fallback)

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if BK_HOME is set (needed for the analyze script location)
if [ -z "$BK_HOME" ]; then
    echo -e "${RED}Error: BK_HOME environment variable is not set.${NC}"
    echo "Please set BK_HOME to the root directory of your claude-skills repository."
    echo "Example: export BK_HOME=\$HOME/Documents/ws/claude-skills"
    exit 1
fi

# Check if BK_HOME directory exists
if [ ! -d "$BK_HOME" ]; then
    echo -e "${RED}Error: BK_HOME directory does not exist: $BK_HOME${NC}"
    exit 1
fi

# Path to the analyze-skills.py script (in src/ for easier maintenance)
ANALYZE_SCRIPT="$BK_HOME/src/skill-usage/analyze-skills.py"

# Check if the analyze script exists
if [ ! -f "$ANALYZE_SCRIPT" ]; then
    echo -e "${RED}Error: analyze-skills.py script not found at: $ANALYZE_SCRIPT${NC}"
    exit 1
fi

# Function to find project root by walking up looking for .claude directory
find_project_root() {
    local dir="$1"
    while [ "$dir" != "/" ]; do
        if [ -d "$dir/.claude" ]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    return 1
}

# Determine log directory with clear precedence
LOG_SOURCE=""
if [ -n "$1" ]; then
    # Option 1: Command-line argument provided
    LOG_DIR="$1"
    LOG_SOURCE="command-line argument"
elif [ -d "$HOME/.claude/activity-logs" ]; then
    # Option 2: Global Claude activity logs (default - hooks write here)
    LOG_DIR="$HOME/.claude/activity-logs"
    LOG_SOURCE="global ~/.claude (default)"
else
    # Try to find project root from current directory (legacy fallback)
    PROJECT_ROOT=$(find_project_root "$(pwd)")

    if [ -n "$PROJECT_ROOT" ] && [ -d "$PROJECT_ROOT/.claude/activity-logs" ]; then
        # Option 3: Found activity logs in project root (legacy)
        LOG_DIR="$PROJECT_ROOT/.claude/activity-logs"
        LOG_SOURCE="project directory ($PROJECT_ROOT) - legacy"
    elif [ -d "$BK_HOME/.claude/activity-logs" ]; then
        # Option 4: Fall back to BK_HOME (legacy)
        LOG_DIR="$BK_HOME/.claude/activity-logs"
        LOG_SOURCE="BK_HOME fallback - legacy"
    else
        # No logs found anywhere
        echo -e "${RED}Error: No activity logs found.${NC}"
        echo ""
        echo "Searched in:"
        echo "  1. Global: $HOME/.claude/activity-logs"
        if [ -n "$PROJECT_ROOT" ]; then
            echo "  2. Project root: $PROJECT_ROOT/.claude/activity-logs"
        else
            echo "  2. Current directory: $(pwd)/.claude/activity-logs (no .claude dir found)"
        fi
        echo "  3. BK_HOME: $BK_HOME/.claude/activity-logs"
        echo ""
        echo "To enable skill tracking, run the install-skill-tracker skill in your project."
        exit 1
    fi
fi

# Verify the log directory exists and has files
if [ ! -d "$LOG_DIR" ]; then
    echo -e "${RED}Error: Log directory does not exist: $LOG_DIR${NC}"
    exit 1
fi

# Check for actual log files
SKILL_LOG="$LOG_DIR/skill-usage.jsonl"
PROMPT_LOG="$LOG_DIR/prompts.jsonl"

if [ ! -f "$SKILL_LOG" ] && [ ! -f "$PROMPT_LOG" ]; then
    echo -e "${YELLOW}Warning: No log files found in: $LOG_DIR${NC}"
    echo ""
    echo "Expected files:"
    echo "  - skill-usage.jsonl"
    echo "  - prompts.jsonl"
    echo ""
    echo "Use skills in Claude Code and they'll be tracked automatically."
    exit 0
fi

# Determine project directory (parent of .claude/activity-logs)
PROJECT_DIR=$(dirname $(dirname "$LOG_DIR"))

# Generate output filename with date
DATE_STAMP=$(date +%Y-%m-%d)
HTML_OUTPUT="/tmp/bk-analyze-skill-usage-${DATE_STAMP}.html"

# Display header with directory info
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Skill Usage Analysis Report${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${CYAN}Log directory:${NC} $LOG_DIR"
echo -e "${CYAN}Project:${NC} $PROJECT_DIR"
echo -e "${CYAN}Source:${NC} $LOG_SOURCE"
echo ""

# Run the Python analysis script with HTML output
python3 "$ANALYZE_SCRIPT" "$LOG_DIR" --project "$PROJECT_DIR" --html -o "$HTML_OUTPUT"

# Open the HTML report in default browser
if [ -f "$HTML_OUTPUT" ]; then
    echo -e "${GREEN}Opening report in browser...${NC}"
    open "$HTML_OUTPUT"
else
    echo -e "${RED}Failed to generate HTML report${NC}"
    exit 1
fi

echo ""
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
